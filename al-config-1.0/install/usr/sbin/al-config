#!/bin/bash
#
# Copyright Â© 2019 Oracle Corp., Inc.  All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at http://oss.oracle.com/licenses/upl
#
# al-config: configuration for OCI CLI
#

. /usr/lib/al-config/functions

usage() {
    cat >&2 << EOF
Usage: $0 [OPTION]...
 -u OCI User OCID
 -t OCI tenancy OCID
 -T OCI notification service topic OCID
 -k OCI API key file
 -f OCI API public key fingerprint
 -p OCI API key pass phrase file
 -h This message
EOF
    exit 1
}

run_as_root_check

while getopts "u:k:p:f:t:T:h" OPTION; do
    case "$OPTION" in
      u)
        oci_user=$OPTARG
        ;;
      k)
        oci_key_file_from=$OPTARG
        ;;
      p)
        oci_key_pass_phrase_from=$OPTARG
        ;;
      f)
        oci_key_fingerprint=$OPTARG
        ;;
      t)
        oci_tenancy=$OPTARG
        ;;
      T)
        oci_topic=$OPTARG
        ;;
      h)
        usage
        ;;
      *)
        usage
        ;;
    esac
done

if [ -z "$oci_user" -o -z "$oci_key_file_from" -o -z "$oci_key_fingerprint" -o \
    -z "$oci_tenancy" -o -z "$oci_topic" ]; then
    usage
fi

oci_key_file_content=$(read_file "$oci_key_file_from")
if [ -z "$oci_key_file_content" ]; then
    echo "Could not read $oci_key_file_from" >&2
    exit 1
fi

if [ -z "$oci_key_file_content" ]; then
    echo "Could not read $oci_key_file_from" >&2
    exit 1
fi

# It's ok that the key is not encrypted
# So do not exit if key pass phrase file doesn't exit or empty
if [ -n "$oci_key_pass_phrase_from" ]; then
    oci_key_pass_phrase=$(read_file "$oci_key_pass_phrase_from")
else
    oci_key_pass_phrase=""
fi

# initial config
region=$(curl -sfm 25 \
    http://169.254.169.254/opc/v1/instance/canonicalRegionName 2>/dev/null)

cat > $oci_cli_config_file <<CONFIG
[DEFAULT]
user = $oci_user
key_file = $oci_api_key_file
fingerprint = $oci_key_fingerprint
pass_phrase = $oci_key_pass_phrase
tenancy = $oci_tenancy
region = $region
CONFIG
chmod 600 $oci_cli_config_file

# set api key
echo "$oci_key_file_content" > $oci_api_key_file
chmod 600 $oci_api_key_file

log "Configured $oci_cli_config_file"

if [ ! -f "$oci_config_file" ]; then
    cat > $oci_config_file <<EOF
# This file is a bourne shell snippet, and is sourced by the
# script al-notify for configuration.

EOF
fi

# set topic OCID to oci.conf
if grep -q "^topic=" $oci_config_file; then
    sed -i "s/^topic=.*/topic=$oci_topic/g" $oci_config_file
else
    echo "# OCI notification service topic OCID" >> $oci_config_file
    echo "topic=$oci_topic" >> $oci_config_file
fi
log "Configured $oci_config_file"
