#!/bin/bash
#
# Copyright Â© 2019 Oracle Corp., Inc.  All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at http://oss.oracle.com/licenses/upl
#
# al-exploit-alert: alert for exploit attempts
# This script should be triggered by rsyslog

. /usr/lib/al-config/functions

usage() {
    cat >&2 << EOF
Usage: $0 [OPTION]...
 -h This message
EOF
    exit 1
}

run_as_root_check

while getopts "h" OPTION; do
    case "$OPTION" in
      h)
        usage
        ;;
      *)
        usage
        ;;
    esac
done

acquire_lock

msg=$(journalctl -b | grep "exploit attempt detected" | tail -1)

if [ -n "$msg" ]; then
    instance_name=$(get_instance_name)
    msg_file=$(mktemp $work_dir/alert_XXXX)
    cat > $msg_file <<EOF
+------------------------------------------------------------------------+
|  Exploit attempt detected! ($(date))              |
+------------------------------------------------------------------------+
$msg

Logged in users:
$(who)
EOF
    al-notify -t "AL: Exploit attempt detected on instance $instance_name" -f \
        $msg_file
    rm -f $msg_file
fi

release_lock
